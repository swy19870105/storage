## 备份系统的设计和备份技术的选择

原创 *2016-05-24* *EMC中文技术社区* [EMC易安信中国技术社区](https://mp.weixin.qq.com/s?__biz=MjM5NjY0NzAwMg==&mid=2651770930&idx=3&sn=7bf390c566ab243d07986edf65d2edb7&scene=21##)

​     本文中笔者小结一些自己对于备份系统的设计和备份技术的选择方面的心得，并结合EMC的产品，从多角度做一些简要的分析。

 

 

**重复数据删除技术的选择:**

 

​     备份的时候进行重复数据的删除的好处是显而易见的，也已成为目前业界的主流技术。这类技术目前的发展方向，最常见的方式，以除重操作发生的位置来划分：

1. 在数据源端(基于主机)备份，备份之前就做除重了，然后再备份。这种方式能避免更多重复数据为了消重而通过网络传输到备份服务器，减轻了网络压力，但是缺点是会占用备份客户机的时间和资源来做消重。
2. 在备份服务器端来做除重，在线处理（Inline或联机处理），Data Domain就是这一技术的代表，这一方式中，数据在读进来之后，在存到磁盘之前就已经进行了重复数据删除，也就是一边备份，一边除重。In-line的优势是节省了磁盘空间，同时重复数据删除一步到位，特别简单，但缺点是对CPU的损耗非常大，会占用大量CPU资源，导致性能下降。

 

![img](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArOvxh6xoHsJic6vb7ObtzBfxfkGWHyiaAg7s02EddvJcm7ebbGBZkqj7g/0?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1)

 

​     所以我们在选择使用哪种重复数据删除技术的时候应该先弄清楚，自己的重复数据在哪里发生的最多，再决定是不是在那个位置来进行重复数据删除。假如是在一个企业内部，发件人给所有员工发了一封带附件的邮件，这些数据都是存储在主机上，这种情况下可以采用基于主机的重复数据删除。

​     Avamar软件和Data Domain重复数据删除存储系统是目前EMC重复数据删除解决方案的核心。在EMC的重复数据删除技术蓝图中，Avamar和Data Domain被赋予不同的工作目标，Avamar更侧重于源端，更偏向在VMware虚拟化环境、备份服务器、在线复制等应用领域，其最新的进展是EMC将Avamar推进到了桌面和移动办公领域；Data Domain的工作则更多的侧重在目标端，即业务系统后端所连接的存储、备份和归档、容灾设备。

 

 

**可扩展性的选择:**

 

 ![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)

 

​     企业级的备份系统的架构应当是及其灵活的和可延展的，这样才是对分布式企业环境来说的理想的解决方案。公司的备份策略要从一个中心区域到遍及所有机构，都能够得到技术实现、贯彻执行和集中管理。备份系统要支持本地区域网络和广泛区域网络的连接。

​     在系统实施以后，数据在不同的物理站点之间的传递流转产生的网络压力要尽可能地减少。无论本地还是远程的主机上的数据都集中备份到中心区域的服务器上。作为一个集中化的备份系统，它不需要在分支机构的站点部署任何的硬件或者驻留任何的备份管理员就能对这些分支机构的数据提供保护。

​     对一个拥有众多分支机构的大型企业来说，我们在一个集中化的备份系统里就能够备份所有分支机构的数据并自动复制备份数据到中心站点和专门的灾备站点。此外，我们还能把存储在中心备份服务器上的管理数据和用户数据都复制到一个远程的灾备站点。所有的备份、恢复和复制的活动都在中央数据中心使用亲和的图形化界面的工具统一管理。

 

** **

**灾备技术的选择：**

 

 

[![img](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArBibPdNKJWot5s8chU8l4cR0TeQ7mQCgABSM8Yvbib5AzgHv2Qia4zYKjg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)]()

​     最常见的灾备技术就是异地复制，就是把本地备份系统上的数据通过广域网复制到远程的备份系统上。为了减少网络流量和节约时间，我们应当只把经过重复数据消除技术处理过的备份数据复制到灾备系统上。

 

​      理解与复制技术有关的所有硬件和软件，对于设计一套备份和恢复系统是非常重要的。作为设计者，需要考虑到的方方面面包括：

1. 一套受支持的存储阵列，例如：EMC Symmetrix 或者CLARiiON，或者其他具备合适级别的固件和API的存储阵列
2. 一套受支持的快照软件解决方案，例如：MS VSS，EMC TimeFinder或者SnapView
3. 一套受支持的操作系统并安装了备份软件的服务器版，客户机版和任何需要的备份代理程序，例如：EMC Networker，Samentac NetBackup
4. 一系列经过授权的备份软件的应用模块，适用于普通电脑终端的备份、数据库的备份、大数据量文件系统的备份，例如：Networker server/client，Networker SnapImage， Networker Module for Oracle
5. 一套受支持的物理卷（介质）管理工具，例如：EMC Unisphere
6. 一套受支持的备份源端到目标端的数据传递的多路径解决方案，例如：EMC PowerPath
7. 一个设计合理的整体基础架构，例如：基于共享存储的SAN，基于主机自用磁盘的LAN

 

 

​      许多用户都会在设计和实施复制方案的时候面对这样一个简单的问题：要不要使用备份软件来管理基于磁盘存储的复制？

实现备份和复制不仅仅要考虑清楚硬件和软件，还要分清业务需求和要求。考量一个复制方案是否经得起推敲，可以从以下方面入手：

1. 对于商务应用和业务数据来说，怎样的恢复时间目标（RTO）和恢复时间点目标（RPO）是可以接受的？
2. 备份数据和复制数据要分别安排在怎样的时间窗口内才是合理的？
3. 谁来执行数据恢复？恢复工具易于操作吗？恢复流程明确周详吗？
4. 目前备份系统用到了哪些硬件技术和软件技术？
5. 可用于改善备份系统的财务预算和实施周期是怎样定义的？

 

 

​     那么，那种备份解决方案最好呢？这个问题的答案必须基于用户对上述问题的考虑以及最终确定的各个细节。业务系统的类型和使用环境的可用性极大程度地触发了一个又一个实施方案的选择。

​     镜像和克隆典型地被用在含有重要数据的环境中，尤其是在短时间内会发生大量数据改变的情况，但是他们的使用成本和维护成本会高于仅使用快照技术的备份系统。

​      在Microsoft Windows的环境中，推荐使用VSS快照技术完成备份作业。

​      对于含有大数据量的文件系统，推荐使用Server less和NDMP技术。

​      实现基于任意时间点的恢复能最大限度地达到RTO和RPO，EMC Recoverpoint能提供这方面的解决方案。

 

 

**虚拟机备份技术的选择：    **

 

​     不同的数据中心环境适用不同的方案。主流的实现方式包括：

Guest-based：基于客户机的方式。这种方式的配置和备份物理机的配置如出一辙，没有任何额外的步骤。在此不表。

vStorage APIs：基于代理服务器的方式。这是目前最高效的方式。

 

 

[![img](data:image/gif;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQImWNgYGBgAAAABQABh6FO1AAAAABJRU5ErkJggg==)]()

 

​     这样的数据保护就能支持LAN-free的备份，并且把所有备份相关的资源开销都集中到一个代理服务器上。备份的时候，系统会创建一个虚拟机的vmdk文件的快照，这个vStorage APIs的代理服务器能够挂载这个快照，并通过备份软件直接备份这个快照，这样的备份就是镜像级别的了。当然为了让备份服务器能识别和管理这个代理服务器，我们需要在他上面安装备份软件的代理程序，由这个代理程序提供备份服务，所有的备份操作都在这个代理服务器上完成。一个代理服务器能为多个ESX主机上的虚拟机提供备份服务。

​     考虑到效率，我们建议把这些虚拟机都部署在共享存储环境中，例如：SAN，便于代理服务器读写。笔者的经验是，如果把这个代理服务器也存放在同一套共享存储中，备份的效率会更高。

 

 

**设计一个完整的备份架构：**

 

​     就以下图作为模拟，整理下构建备份系统的思路。

[![img](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArtYYIVt6Cq7xaibicGIEnMTAbGrWaeS458IbUvlJdppWGicFXcUpagh6jw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)]()

 

​     首先，横向来看，既要有在线备份，也要有离线备份。数据从左至右依次经过客户端、备份服务器、一级存储介质、二级存储介质。在备份系统中，我们要规划好各层之间的网络连接，部署成本和管理平台。如果需要异地长期保存数据的，还要考虑如何转移磁带，如何存放和管理便于恢复的时候支取。对于多级存储介质，磁盘阵列和磁带库，最好能通过统一存储工具进行管理，而且容量、性能和高可用性是最主要的三个方面，需要在成本允许的范围内取得平衡。事先和应用部门就这些方面做一次modeling来明确这些方面的细节。

​     然后，纵向来看，既要有磁带备份，也要有磁盘备份。至于两者之间的比较，就不再本文赘述了。感兴趣的读者，请自行查找其他资料。值得一提的是，在现在介质成本不断下降的大环境下，磁盘的优势非常明显，建议有条件优先考虑，选择知名厂商的成熟存储阵列产品。

​     最后，我们推荐结合EMC的三大备份产品搭建这个环境。

​     利用Avamar和Networker内嵌的DD Boost向Data Domain目标备份Exchange、Oracle、SharePoint、SQL Server和VMware镜像。Avamar自有的Data Store有效容量翻番达到124TB。与之相比，Data Domain目标系统可用容量为285TB。Networker更是能通过添加外部设备直接使用更多更大容量的一级磁盘阵列和二级磁带库。用户能够将DD Boost所支持应用的备份发送至Data Domain目标，而其他应用备份将发送至Avamar Data Store，以此最大化备份整体性能，并加速Avamar和Networker客户端。

​     Networker备份客户端在备份时，可以选择要除重还是不要除重。如果不要除重，把它备份到Networker后面管理的其他备份设备上，可以是一级磁盘阵列也可以是二级磁带库，甚至Data Domain都是可以的。另一个是带除重的选项，这时选中后，备份设备备份到Avamar或者Data Domain的磁盘里，这个结合的好处：用同一个客户端选择要除重还是不要除重，并且整个备份策略是由Networker统一管理的，也就是说这个数据用了除重或非除重的备份方式，备份的数据存在什么样的备份设备上，还有备份策略、备份周期，是什么样的都是由Networker来管理的，所以有一些客户已经把Avamar，Networker和Data Domain结合起来一起使用了。

  

 

**备份系统“软”技术的选择：**

 

 

[![img](http://mmbiz.qpic.cn/mmbiz/TztEwAzAQIWAGvxjLAAhuXGiawkNAUBArD7Ztlt7vdWyicj8kk0KsQnRp3jwulc0sSQoNgs5kSYq6BWrkvnPRTog/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1)]()

​     写到最后，笔者想把对备份系统设计中最容易被轻视的“软”技术的探讨作为本位的结尾。所谓的“软”技术，包括这些内容：

1. 根据业务的需求，我们要制定怎样的备份策略才能在充分利用上述所有系统配置和环境资源来实现日常的备份任务？
2. 哪些技术和非技术人员会参与备份系统的日常维护和管理，他们的身份验证和系统权限作出了怎样的定义？
3. 当需要进行数据恢复的时候，流程足够清晰吗？恢复数据直接可用吗？